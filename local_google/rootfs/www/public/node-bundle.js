(()=>{"use strict";const e=require("buffer"),o="0.0.165";var t=smarthome.App,s=smarthome.IntentFlow.ErrorCode,n=smarthome.Intents,a=smarthome.DataFlow,r=smarthome.Constants,c=smarthome.Execute;const i=new t(o);i.onIdentify((async t=>{console.debug("onIdentify request");const s=t.inputs[0].payload.device;if(void 0===s.udpScanData)throw Error(`identify request is missing discovery response: ${t}`);const a=e.Buffer.from(s.udpScanData.data,"hex"),r=JSON.parse(a.toString());console.log("discoveryData:",r);const c={intent:n.IDENTIFY,requestId:t.requestId,payload:{device:{id:r.id,isLocalOnly:r.isLocalOnly,isProxy:r.isProxy,deviceInfo:{hwVersion:"UNKNOWN_HW_VERSION",manufacturer:"Home Assistant",model:"Home Assistant",swVersion:o}}}};return console.debug("IDENTIFY response",c),c})).onReachableDevices((async e=>{console.debug("onReachableDevices request",e.requestId);const o=await i.getDeviceManager(),t=e.inputs[0].payload.device.id;console.debug("onReachableDevices proxyDeviceId",t);const s=new a.HttpRequestData;s.protocol=r.Protocol.HTTP,s.method=r.HttpOperation.GET,s.requestId=e.requestId,s.deviceId=t,s.port=8089,s.path="/api/local/reachableDevices",s.dataType="application/json",s.additionalHeaders={};try{let t=await o.send(s);const a=JSON.parse(t.httpResponse.body);console.debug("onReachableDevices serverDevices",a);const r=a.map((e=>({verificationId:e.localId})));console.debug("onReachableDevices devices",r),console.debug("onReachableDevices devices stringify",JSON.parse(JSON.stringify(r)));const c={intent:n.REACHABLE_DEVICES,requestId:e.requestId,payload:{devices:r}};return console.debug("onReachableDevices response",c),c}catch(e){throw console.error("Error making request",e),e}})).onQuery((async e=>{console.debug("onQuery request");const o=e.inputs[0].payload,t=o.devices;console.log("payload",o);const s=await i.getDeviceManager(),n=[];for(const o of t){const t=new a.HttpRequestData;let c;t.protocol=r.Protocol.HTTP,t.method=r.HttpOperation.POST,t.requestId=e.requestId,t.deviceId=o.id,t.port=8089,t.path="/api/local/query",t.dataType="application/json",t.additionalHeaders={};try{c=await s.send(t),console.log("onQuery rawResponse",c.httpResponse.statusCode,c.httpResponse.body),n.push(...c.httpResponse.body.devices)}catch(e){throw console.error("onQuery",e),e}}return console.log("onQuery result",n),{requestId:e.requestId,payload:{devices:n}}})).onExecute((async e=>{console.debug("onExecute request"),console.debug("EXECUTE request",e);const o=(new c.Response.Builder).setRequestId(e.requestId),t=await i.getDeviceManager(),n=e.inputs[0].payload.commands,d=n[0],l=d.devices[0].id;console.log("commands",n,l);const u=new a.HttpRequestData;let p;u.protocol=r.Protocol.HTTP,u.method=r.HttpOperation.POST,u.requestId=e.requestId,u.deviceId=l,u.port=8089,u.path="/api/local/execute",u.data=JSON.stringify(n),u.dataType="application/json",u.additionalHeaders={};try{p=await t.send(u),console.debug("Request statusCode",p.httpResponse.statusCode)}catch(e){console.error("Request Failed",e),o.setErrorState(d.devices[0].id,s.GENERIC_ERROR)}return console.log("onExecute response",JSON.stringify(o)),console.log("onExecute response stringify",JSON.parse(JSON.stringify(o))),o.build()})).listen().then((()=>{console.log("Ready to listen HA Agent",o)})).catch((e=>console.error("App Error",e)))})();